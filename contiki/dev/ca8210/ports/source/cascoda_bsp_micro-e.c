/*
 * Copyright (c) 2016, Cascoda Limited and/or its
 * affiliated group companies.
 *
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote
 *    products derived from this software without specific prior
 *    written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#include "contiki.h"
#include "pic32_irq.h"
#include "pic32_spi.h"
#include "pic32_gpio.h"
#include "pic32_uart.h"
#include "dev/ca8210/cascoda/include/cascoda_types.h"
#include "dev/ca8210/ports/include/cascoda_bsp.h"

#include <stdio.h>

/******************************************************************************/
/****** Global Variables                                                 ******/
/******************************************************************************/
u32_t     TimerValue    = 0;


/******************************************************************************/
/******************************************************************************/
/****** BSP_StartTimerUs()                                               ******/
/******************************************************************************/
/****** Brief:  Start 1 us Timer - uses Timer2 for Polling               ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_StartTimerUs(void)
 {
 TimerValue = clock_time();
 } // End of BSP_StartTimerUs()


/******************************************************************************/
/******************************************************************************/
/****** BSP_StopTimerUs()                                                ******/
/******************************************************************************/
/****** Brief:  Stop 1 us Timer - uses Timer2 for Polling                ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_StopTimerUs(void)
 {
 ;
 } // End of BSP_StopTimerUs()


/******************************************************************************/
/******************************************************************************/
/****** BSP_GetTimerUs()                                                 ******/
/******************************************************************************/
/****** Brief:  Get 1 us Timer - uses Timer2 for Polling                 ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: Time in [us] since Timer was started                     ******/
/******************************************************************************/
/******************************************************************************/
u32_t BSP_GetTimerUs(void)
 {
 u32_t tus;
 tus = (clock_time() - TimerValue)*1000;
 return(tus);
 } // End of BSP_GetTimerUs()


/******************************************************************************/
/******************************************************************************/
/****** BSP_ReadAbsoluteTime()                                           ******/
/******************************************************************************/
/****** Brief:  Record the start time for an event                       ******/
/******************************************************************************/
/****** Param:                                                           ******/
/******************************************************************************/
/****** Return: -  Absolute time in milliseconds                         ******/
/******************************************************************************/
/******************************************************************************/
u32_t BSP_ReadAbsoluteTime( void )
{
return AbsoluteTicks;
} // End of BSP_ReadAbsoluteTime()


/******************************************************************************/
/******************************************************************************/
/****** BSP_ShowTitle()                                                  ******/
/******************************************************************************/
/****** Brief:  Put Title on LCD                                         ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_ShowTitle( u8_t *pString )
{
;
} // End of BSP_ShowTitle()


/******************************************************************************/
/******************************************************************************/
/****** BSP_ShowTime()                                                   ******/
/******************************************************************************/
/****** Brief:  Put Time on LCD                                          ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_ShowTime( void )
{
;
} // End of BSP_ShowTime()


/******************************************************************************/
/******************************************************************************/
/****** BSP_WaitTicks()                                                  ******/
/******************************************************************************/
/****** Brief:  Wait for specified Ticks Time                            ******/
/******************************************************************************/
/****** Param:  Ticks - Time in Ticks (1ms/100ms)                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_WaitTicks( u32_t Ticks)
{
    u32_t  Start;

    Start = AbsoluteTicks;
    while ( ( AbsoluteTicks - Start ) < Ticks ) {};
} // End of BSP_WaitTicks()


/******************************************************************************/
/******************************************************************************/
/****** BSP_ResetRF()                                                    ******/
/******************************************************************************/
/****** Brief:  Reset CAX RF Chip                                        ******/
/******************************************************************************/
/****** Param:  ms - Reset Low Time in [ms]                              ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_ResetRF(u8_t ms)
 {
 u32_t ticks;

 ticks = (u32_t)ms;

 // reset board with RSTB
 GPIO_CLR(CA8210_NRESET_PORT, CA8210_NRESET_PIN);
 BSP_WaitTicks(ticks);
 GPIO_SET(CA8210_NRESET_PORT, CA8210_NRESET_PIN);
 BSP_WaitTicks(50);

 } // End of BSP_ResetRF()


/******************************************************************************/
/******************************************************************************/
/****** BSP_SerialWriteAll()                                             ******/
/******************************************************************************/
/****** Brief:  Write Buffer of Data to Serial                           ******/
/******************************************************************************/
/****** Param:  pBuffer - Pointer to Data Buffer                         ******/
/****** Param:  BufferSize - Size of Data Buffer                         ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_SerialWriteAll( u8_t *pBuffer, u32_t BufferSize)
{
u32_t i;

for(i=0;i<BufferSize;++i)
 pic32_uart3_write(pBuffer[i]);

} // End of BSP_SerialWriteAll()


/******************************************************************************/
/******************************************************************************/
/****** BSP_SerialRead()                                                 ******/
/******************************************************************************/
/****** Brief:  Read Character(s) from Serial                            ******/
/******************************************************************************/
/****** Param:  pBuffer - Pointer to Data Buffer                         ******/
/****** Param:  BufferSize - Max. Characters to Read                     ******/
/******************************************************************************/
/****** Return: Number of Characters placed in Buffer                    ******/
/******************************************************************************/
/******************************************************************************/
u32_t BSP_SerialRead( u8_t *pBuffer, u32_t BufferSize)
{
// not used in this build, interrupt driven
return 0;
} // End of BSP_SerialRead()


/******************************************************************************/
/******************************************************************************/
/****** BSP_SenseRFIRQ()                                                 ******/
/******************************************************************************/
/****** Brief:  Sense whether SPI IRQ is high or low                     ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: State of IRQ Pin                                         ******/
/******************************************************************************/
/******************************************************************************/
u8_t BSP_SenseRFIRQ( void )
{
    u8_t i;
	u8_t sense = 0;

    for(i=0;i<5;++i)               // de-glitch over 5 samples
     {
	 if(GPIO_VALUE(CA8210_NIRQ_PORT, CA8210_NIRQ_PIN))
      sense = 1;
     }

    return sense;
} // End of BSP_SenseRFIRQ()


/******************************************************************************/
/******************************************************************************/
/****** BSP_SetRFSSBHigh()                                               ******/
/******************************************************************************/
/****** Brief:  Put SPI Select (SSB) Pin high                            ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_SetRFSSBHigh( void )
{
 GPIO_SET(CA8210_SSB_PORT, CA8210_SSB_PIN);
} // End of BSP_SetRFSSBHigh()


/******************************************************************************/
/******************************************************************************/
/****** BSP_SetRFSSBLow()                                                ******/
/******************************************************************************/
/****** Brief:  Put SPI Select (SSB) Pin low                             ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_SetRFSSBLow( void )
{
 GPIO_CLR(CA8210_SSB_PORT, CA8210_SSB_PIN);
} // End of BSP_SetRFSSBLow()


/******************************************************************************/
/******************************************************************************/
/****** BSP_SPIInit()                                                    ******/
/******************************************************************************/
/****** Brief:  Initialise GPIO and SPI Pins for Comms with CA-821X      ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_SPIInit( void )
{
//  For Pin Assignments see cascoda_bsp.h

#ifdef __USE_BREAKOUT_BOARD__
  pic32_spi1_init(CA8210_SPI_BAUDRATE, CA8210_SPI_SETUP);
#else
  pic32_spi2_init(CA8210_SPI_BAUDRATE, CA8210_SPI_SETUP);
#endif

#ifdef __USE_BREAKOUT_BOARD__
GPIO_CONFIGURE_AS_DIGITAL(CA8210_SSB_PORT,    CA8210_SSB_PIN);
#else
GPIO_CONFIGURE_AS_DIGITAL(CA8210_NRESET_PORT, CA8210_NRESET_PIN);
GPIO_CONFIGURE_AS_DIGITAL(CA8210_NIRQ_PORT,   CA8210_NIRQ_PIN);
#endif

GPIO_CONFIGURE_AS_INPUT(CA8210_NIRQ_PORT,    CA8210_NIRQ_PIN);
GPIO_CONFIGURE_AS_OUTPUT(CA8210_NRESET_PORT, CA8210_NRESET_PIN);
GPIO_CONFIGURE_AS_OUTPUT(CA8210_SSB_PORT,    CA8210_SSB_PIN);

BSP_SetRFSSBHigh();
} // End of BSP_SPIInit()


/******************************************************************************/
/******************************************************************************/
/****** BSP_SPIExchangeByte()                                            ******/
/******************************************************************************/
/****** Brief:  Transmit Byte to SPI and Receive Byte at same Time       ******/
/******************************************************************************/
/****** Param:  OutByte - Character to transmit                          ******/
/******************************************************************************/
/****** Return: Character received                                       ******/
/******************************************************************************/
/******************************************************************************/
u8_t BSP_SPIExchangeByte( u8_t OutByte )
{
int outword;

outword = (int)OutByte;

SPIBUF = outword;

while(!SPISTATbits.SPIRBF)
 ;

return (u8_t)(SPIBUF & 0xFF);
} // End of BSP_SPIExchangeByte()


/******************************************************************************/
/******************************************************************************/
/****** BSP_Initialise()                                                 ******/
/******************************************************************************/
/****** Brief:  Inititialisation Procedure derived from main()           ******/
/******************************************************************************/
/****** Param:  -                                                        ******/
/******************************************************************************/
/****** Return: -                                                        ******/
/******************************************************************************/
/******************************************************************************/
void BSP_Initialise(void)
{
;
}
